# FigmaプラグインC 最終ドキュメント（引き継ぎ用）

対象：次の開発者/AI がこれだけで把握できるようにする  
目的：拡張Bが出力するJSONをFigmaで再構築（Frame/Rect/Text/Image）し、可能な範囲で自動レイアウト・命名を行う

---

## 0. ゴールと現状の完成度
- 拡張BのJSON（v1）を読み込み、Figma上にフレーム/矩形/テキスト/画像を生成
- テキストは正規化済み・Auto Text Width デフォルトON
- 画像はdataURL埋め込みに対応、失敗時はプレースホルダー表示
- セマンティックタグをFrame化、不要ラッパーを圧縮
- Flex row/column で安全に当てられる範囲のみAuto Layoutを自動適用
- レイヤー命名を改善（Text/Image/Tag#id/.class）

---

## 1. ファイル構成
```
figcap-figma-plugin/
  manifest.json    # main/uiの定義
  code.js          # メインロジック（Figmaサンドボックス）
  ui.html          # UI (iframe)
```

### manifest.json（要点）
```json
{
  "name": "FigCap C (JSON -> Figma)",
  "id": "figcap-c-json-to-figma-local",
  "api": "1.0.0",
  "main": "code.js",
  "ui": "ui.html",
  "documentAccess": "dynamic-page",
  "editorType": ["figma"]
}
```

---

## 2. UI (ui.html)
- JSONファイル選択 or テキストペースト
- Import File / Import Text / Clear / Close
- オプション: `preservePosition`（デフォルトtrue）, `autoTextWidth`（デフォルトON）
- 結果・エラーをlogに表示  
通信: `parent.postMessage({ pluginMessage: { type: "IMPORT_JSON", jsonText, options } }, "*");`

---

## 3. メインロジック (code.js)
### フロー
1. `validateFigcapJson` (version=1, selections[], rootRect, layers必須)
2. `importFigcapToFigma`  
   - preservePosition=true: selectionsのrootRectでBBoxを作り、その位置関係で配置  
   - false: 縦積み（gap=80）
3. selectionごとにFrameを生成し、layersを処理
4. セマンティックタグ（header/nav/main/section/article/aside/footer）はFrame化
5. Wrapper圧縮：装飾なし＆子1つ、サイズほぼ同じBOXを潰す
6. レイヤー生成: TEXT/IMAGE/BOX
7. Flex row/columnかつ安全な場合のみAuto Layout適用

### レイヤー生成
- TEXT: フォント解決→load→textAutoResize(オプションでWIDTH_AND_HEIGHT)→サイズ調整
- IMAGE/BOX: Rectangleで生成、ImageはdataUrl→createImage、失敗時はプレースホルダー
- 命名:  
  - Text: `Text: <サマリ24文字>`  
  - Image: `Image: <alt or filename>`  
  - Box/Frame: `Tag#id` or `Tag.class`（ユーティリティ除外）

### スタイル適用
- opacity, fills(bg-color), strokes(border), corner radius, drop shadow, effects
- TEXT: color, font-size, weight→style, line-height, letter-spacing, textAlignHorizontal/Vertical(TOP)

### Auto Layout（安全枠のみ）
- 対象: display:flex/inline-flex かつ flex-direction=row/column, wrapなし
- 幾何チェック: 主軸方向に単調増加、重なり大でない
- 設定: layoutMode(HORIZONTAL/VERTICAL), itemSpacing(gap), padding*, primaryAxisAlignItems(justify), counterAxisAlignItems(align-items), stretch→子layoutAlign=STRETCH
- wrap/gridは未対応（将来拡張）

### 画像
- dataUrl→figma.base64Decode→createImage、例外は握り潰し継続
- IMAGE typeでdataUrlなし→プレースホルダー（灰背景+枠+テキスト）

### Wrapper圧縮
- 非セマンティックBOXで装飾なし、子1つ、サイズほぼ同じ→親付け替えで潰す（最大5パス）

---

## 4. 想定JSONフォーマット（拡張B v1）
```json
{
  "version": 1,
  "capturedAt": "...",
  "page": { "url": "...", "title": "...", "viewport": {...}, "scroll": {...} },
  "selections": [
    {
      "id": "...",
      "rootNodeIndex": 123,
      "rootRect": { "x":0,"y":0,"width":..., "height":... },
      "layers": [
        {
          "nodeIndex": 10,
          "parentNodeIndex": 5,
          "tag": "header",
          "type": "BOX" | "TEXT" | "IMAGE",
          "bounds": { "x":..., "y":..., "width":..., "height":... }, // rootRect相対
          "text": "...",
          "style": { /* computed styles: display/bg/border/shadow/font/textAlign/padding/flex/gap... */ },
          "image": { "src": "...", "dataUrl": "...", "alt": "..." },
          "isSemantic": true/false,
          "elemId": "...",
          "elemClass": "...",
          "paintOrder": n
        }
      ],
      "truncated": false
    }
  ]
}
```

---

## 5. 既知の制約 / 注意
- Figma sandboxは一部モダン構文不可：spread/nullish不可。回避済み（Object.assign, apply等）
- createImageはPNG/JPEG/GIFのみ、4096px制限あり
- Auto Layoutは安全枠のみ適用、wrap/gridは非対応
- HUG/FILLは最小限（親はFIXED、stretchは子layoutAlignで対応）
- 外部URL直接fetchはせず、拡張でdataUrl化して渡す前提

---

## 6. テスト観点
1) 正常系：拡張Bの最新JSONをImport → Frame/Text/Imageが生成される  
2) 画像: dataUrl有りで表示、無しでプレースホルダー表示  
3) テキスト: Auto Text Width ON、色/サイズ/weight/line-height/letter-spacing/align が反映  
4) セマンティック階層: header/nav/main/section… がFrame化  
5) Wrapper圧縮: 意味ないラッパーが潰れて階層が浅くなっている  
6) Auto Layout: flex row/col のみ適用、崩れがないか確認  
7) preservePosition ON/OFF で配置が切り替わる  

---

## 7. 今後の拡張アイデア
- wrap対応（layoutWrap + counterAxisSpacing）
- grid対応
- Auto Layout推定のため inferredAutoLayout の活用
- テキストHUG/固定幅判定の精度向上
- 背景fill化や余計なレイヤー削減による軽量化

---

## 8. 引き継ぎメモ
- Chrome拡張Bの出力（v1 JSON）に依存。schemaが変わる場合は validate と import を更新すること。
- 画像は拡張側でdataURL化済みなので、Figma側は createImage に集中すればOK。
- Auto Layoutはあくまで「安全に当たる場合のみ」。壊れやすいケースは layoutMode NONE のまま。

以上でプラグイン側ドキュメントを最新化。拡張Bドキュメント（Doc/ChromeExtention.md）とあわせて参照すれば開発を再開できる状態。***
